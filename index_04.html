<script>
  let capaActual; // para controlar la capa visible

  async function dibujarCapaGeojson(url, key, tabla) {
    // Elimina capa previa si existe
    if (capaActual) {
      map.removeLayer(capaActual);
      capaActual = null;
    }

    try {
      const r = await fetch(`${url}/rest/v1/${tabla}?select=gid,geom`, {
        headers: {
          apikey: key,
          Authorization: `Bearer ${key}`,
          Accept: "application/vnd.pgrst.object+json"
        }
      });

      const json = await r.json();

      // Manejo cuando viene como objeto único o arreglo
      const features = Array.isArray(json) ? json : [json];

      const geojson = {
        type: "FeatureCollection",
        features: features.map(f => {
          const geom = typeof f.geom === "string" ? JSON.parse(f.geom) : f.geom;
          return {
            type: "Feature",
            properties: { gid: f.gid },
            geometry: geom
          };
        })
      };

      capaActual = L.geoJSON(geojson, {
        onEachFeature: function (feature, layer) {
          layer.bindPopup("GID: " + feature.properties.gid);
        }
      }).addTo(map);

      map.fitBounds(capaActual.getBounds());
    } catch (err) {
      console.error(err);
      alert("Error al cargar geometría desde tabla: " + tabla);
    }
  }
</script>
